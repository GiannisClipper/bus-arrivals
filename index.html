<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>test_oasa_api</title>
  <style>
    body {
      font-family:'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif;
      font-size: 0.85em;
    }
    ul {
      list-style-type: none;
      padding: 1em 0 1em 0;
    }
    li {
      background: khaki;
      margin-top: 1px;
      margin-bottom: 1px;
      padding: .25em 0 .25em 0;
    }
    .left {
      display: inline-block;
      vertical-align: top;
    }
    .right {
      display: inline-block;
      vertical-align: top;
      padding: 1.5em 0 0 0;
    }

    .line .icon {
      width:64px;
      height:58px;
    }
    .route .right {
      padding: .75em 0 0 0;
    }
    .route .icon {
      width:32px;
      height:29px;
    }
    .arrival {
      font-weight: 600;
    }
  </style>
</head>
<body>
  <script>
    function createStructureIn($parent) {
      let $left=document.createElement('div');
      $left.className='left';
      $parent.appendChild($left);
      let $icon=document.createElement('img');
      $icon.className='icon';
      $left.appendChild($icon);

      let $right=document.createElement('div');
      $right.className='right';
      $parent.appendChild($right);
      let $header=document.createElement('header');
      $right.appendChild($header);
      let $section=document.createElement('section');
      $right.appendChild($section);

      return {$left:$left, $icon:$icon, $right:$right, $header:$header, $section:$section};
    }
    function emptyStructureIn($section) {
        if ($section.children.length>0) {
          $section.children[0].remove();
          return false;
        } else {
          return true;
        }
    }

    function getLines() {      
      fetch('http://localhost:5000/api/buses?act=webGetLines')
      .then(res=> res.json())
      .then(lines=> {
        let $ul=document.createElement('ul');
        document.body.appendChild($ul);
        lines.map(line=> {
          let $li=document.createElement('li');
          $ul.appendChild($li);
          $li.className='line';
          let stru=createStructureIn($li);
          stru.$icon.src=(line['LineID'].length<3 && parseInt(line['LineID'])!==NaN)?'./icons/bus-yellow.png':'./icons/bus-blue.png';
          stru.$header.textContent=`${line['LineID']}: ${line['LineDescr']} (${line['LineCode']})`;

          $li.dataset.LineID=line['LineID'];
          $li.dataset.LineCode=line['LineCode'];
          $li.addEventListener("click", e=> {
            e.stopPropagation();
            //alert(e.currentTarget.tagName);
            webGetRoutes(e.currentTarget);
          });
        });
      })
      .catch(err=> alert(err.message));
    }

    function webGetRoutes($parent) {
      let $section=$parent.querySelector('section');
      if (emptyStructureIn($section)) {    
        fetch(`http://localhost:5000/api/buses?act=webGetRoutes&p1=${$parent.dataset.LineCode}`)
        .then(res=> res.json())
        .then(routes=> {
          let $ul=document.createElement('ul');
          $section.appendChild($ul);
          let stru;
          routes.map(route=> {
            let $li=document.createElement('li');
            $ul.appendChild($li);
            $li.className='route';
            stru=createStructureIn($li);
            stru.$icon.src='./icons/routes.png';
            stru.$header.textContent=`${$parent.dataset.LineID}: ${route['RouteDescr']} (${route['RouteCode']})`;

            $li.dataset.RouteCode=route['RouteCode'];
            $li.addEventListener("click", e=> {
              e.stopPropagation();
              webGetStops(e.currentTarget);
            });
          });

          if ($ul.children.length==1)
            webGetStops($ul.children[0]);

        })
        .catch(err=> alert(err.message));
      }
    }

    function webGetStops($parent) {
      let $section=$parent.querySelector('section');
      if (emptyStructureIn($section)) { 

        fetch(`http://localhost:5000/api/buses?act=webGetStops&p1=${$parent.dataset.RouteCode}`)
        .then(res=> res.json())
        .then(stops=> {
          let $ul=document.createElement('ul');
          $section.appendChild($ul);
          stops.map(stop=> {
            let $li=document.createElement('li');
            $ul.appendChild($li);
            $li.className='stop';
            stru=createStructureIn($li);
            stru.$icon.src='./icons/stop-red.png';
            stru.$header.textContent=`${stop['StopDescr']} (${stop['StopCode']})`;

            $li.dataset.StopCode=stop['StopCode'];
            $li.addEventListener("click", e=> {
              e.stopPropagation();
              getStopArrivals(e.currentTarget);
            });
          });
        })
        .catch(err=> alert(err.message));
      }
    }

    function getStopArrivals($parent) {
      let $section=$parent.querySelector('section');
      if (emptyStructureIn($section)) { 
        getStopArrivals2($parent, $section);
      }
    }

    function getStopArrivals2($parent, $section) { 
      fetch(`http://localhost:5000/api/buses?act=getStopArrivals&p1=${$parent.dataset.StopCode}`)
      .then(res=> res.json())
      .then(arrivals=> {
        let $ul=document.createElement('ul');
        $section.appendChild($ul);
        if (arrivals) {
          fetch(`http://localhost:5000/api/buses?act=webRoutesForStop&p1=${$parent.dataset.StopCode}`)
          .then(res=> res.json())
          .then(routes=> {
            arrivals.map(arrival=> {
              let $li=document.createElement('li');
              $ul.appendChild($li);
              $li.className='arrival';
              let route=routes.filter(x=> x['RouteCode']===arrival['route_code']);
              let LineID=route[0]['LineID'];
              let RouteDescr=route[0]['RouteDescr'];
              $li.textContent=`${LineID}: ${RouteDescr}: ${arrival['btime2']}'`;
            });
          });
        } else {
          let $li=document.createElement('li');
          $ul.appendChild($li);
          $li.className='arrival';
          $li.textContent=`(no arrivals)`;
        }
      })
      .catch(err=> alert(err.message));
    }

    document.addEventListener("DOMContentLoaded", getLines);
  </script>
</body>
</html>